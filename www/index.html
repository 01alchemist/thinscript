<meta charset="utf8">
<title>ThinScript Compiler Demo</title>
<style>
  body {
    font: 14px/150% sans-serif;
    margin: 50px 0 50px 50px;
  }

  h1, p {
    padding-right: 50px;
    clear: both;
  }

  h1 {
    margin-bottom: 50px;
  }

  p {
    max-width: 800px;
    margin: 0 0 30px 0;
  }

  h2 {
    clear: both;
    margin: 0;
    height: 50px;
    line-height: 30px;
  }

  a {
    color: inherit;
  }

  .not-supported-warning-text {
    display: none;
  }

  .wasm-unavailable .wasm-backend-text {
    color: #BBB;
  }

  .wasm-unavailable .not-supported-warning-text {
    display: inline;
  }

  button {
    position: absolute;
    width: 100px;
    height: 30px;
    top: 50px;
    right: 50px;
    background: white;
    border: 1px solid #BBB;
    border-top-right-radius: 5px;
    border-bottom-left-radius: 5px;
    font: inherit;
    line-height: 20px;
    padding: 1px 0;
    background: linear-gradient(white, #F7F7F7);
    cursor: pointer;
    color: black;
  }

  textarea {
    width: 100%;
    height: 400px;
    resize: vertical;
  }

  button:active:not(:disabled) {
    background: linear-gradient(#EEE, #F7F7F7);
    box-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
    padding: 2px 0 0 0;
  }

  button:focus, textarea:focus {
    outline: none;
    border-color: #777;
    box-shadow: 0 0 4px rgba(0, 0, 0, 0.5);
  }

  textarea:focus + button {
    border-color: #777;
  }

  button:disabled {
    color: black;
    opacity: 0.5;
    cursor: default;
  }

  textarea, code {
    font: 12px/130% Consolas, monospace;
  }

  textarea {
    border: 1px solid #CCC;
    border-radius: 5px;
    padding: 5px;
  }

  section {
    position: relative;
    width: 50%;
    float: left;
    padding: 0 50px 50px 0;
    box-sizing: border-box;
  }

  .spacer {
    height: 50px;
  }
</style>
<body>
  <h1>ThinScript Compiler Demo</h1>

  <p>
    ThinScript is an experimental programming language that compiles to both WebAssembly and JavaScript.
    It's meant to be a thin layer on top of WebAssembly that makes it easier to work with: no dependencies and fast compile times.
    The syntax is inspired by TypeScript and the compiler is <a href="https://github.com/evanw/thinscript">open source</a> and bootstrapped (it can compile itself).
  </p>

  <p>
    This is still an experiment and isn't intended for real use yet.
    The generated code currently doesn't delete anything.
    WebAssembly is a volatile work-in-progress and the binary format will be changed before the final release.
    Debugging support for WebAssembly is non-existent in current implementations.
    You get the idea.
  </p>

  <div class="spacer"></div>

  <section>
    <h2>Input</h2>
    <textarea id="input" autofocus></textarea>
  </section>

  <section>
    <h2>Output</h2>
    <textarea id="output" readonly></textarea>
    <button id="download">Download</button>
  </section>

  <p>
    <b>Compile using:</b>
    <label><input type="radio" name="backend" id="backend-js"> JavaScript</label>
    <label><input type="radio" name="backend" id="backend-wasm"> <span class="wasm-backend-text">WebAssembly<span class="not-supported-warning-text"> (not supported by your browser)</span></span></label>
    <br>
    <b>Compile to:</b>
    <label><input type="radio" name="target" id="target-js"> JavaScript</label>
    <label><input type="radio" name="target" id="target-wasm" checked> WebAssembly<span class="not-supported-warning-text"> (not supported by your browser)</span></label>
    <br>Compile time: <span id="compileTime"></span>
  </p>

  <div class="spacer"></div>

  <section>
    <h2>Usage</h2>
    <textarea id="usage" readonly></textarea>
    <button id="run">Run</button>
  </section>

  <section>
    <h2>Log</h2>
    <textarea id="log" readonly></textarea>
    <button id="clear" disabled>Clear</button>
  </section>
</body>
<script>

(function() {
  var run = document.getElementById('run');
  var clear = document.getElementById('clear');
  var input = document.getElementById('input');
  var output = document.getElementById('output');
  var usage = document.getElementById('usage');
  var log = document.getElementById('log');
  var download = document.getElementById('download');
  var compileTime = document.getElementById('compileTime');

  var backendWebAssembly = document.getElementById('backend-wasm');
  var backendJavaScript = document.getElementById('backend-js');

  var targetWebAssembly = document.getElementById('target-wasm');
  var targetJavaScript = document.getElementById('target-js');

  var loadedWebAssembly = null;
  var loadedJavaScript = null;

  var compiledWebAssembly = null;
  var compiledJavaScript = null;

  var downloadName = null;
  var javaScriptToRun = null;
  var webAssemblyToRun = null;
  var blobToDownload = null;

  function joinLines(lines) {
    return lines.join('\n');
  }

  var example = joinLines([
    'declare function print(text: string): void;',
    '',
    'class Link {',
    '  value: int;',
    '  next: Link;',
    '}',
    '',
    'class List {',
    '  first: Link;',
    '  last: Link;',
    '',
    '  append(value: int): void {',
    '    var link = new Link();',
    '    link.value = value;',
    '',
    '    // Append the new link to the end of the chain',
    '    if (this.first == null) this.first = link;',
    '    else this.last.next = link;',
    '    this.last = link;',
    '  }',
    '}',
    '',
    'extern function main(): int {',
    '  var list = new List();',
    '  list.append(1);',
    '  list.append(2);',
    '  list.append(3);',
    '',
    '  var total = 0;',
    '  var link = list.first;',
    '  while (link != null) {',
    '    total = total + link.value;',
    '    link = link.next;',
    '  }',
    '',
    '  print("hello, world");',
    '  return total;',
    '}',
  ]) + '\n';

  function fetch(url, responseType, callback) {
    var xhr = new XMLHttpRequest;
    xhr.open('GET', url);
    xhr.onload = function() {
      callback(xhr.response);
    };
    xhr.responseType = responseType;
    xhr.send(null);
  }

  function loadJavaScript(callback) {
    fetch('compiled.js', 'text', callback);
  }

  function loadWebAssembly(callback) {
    fetch('compiled.wasm', 'arraybuffer', function(buffer) {
      callback(new Uint8Array(buffer));
    });
  }

  function extractLengthPrefixedString(ints, bytes, index) {
    var text = '', length = ints[index >> 2], i = index + 4;
    while (length-- > 0) text += String.fromCharCode(bytes[i++]);
    return text;
  }

  function loadStdlibForWebAssembly() {
    var stdlib = {
      strings: [],
      bytes: null,
      ints: null,

      assert: function(truth) {
        if (!truth) {
          throw new Error('Assertion failed');
        }
      },

      Profiler_begin: function() {
        time = now();
      },

      Profiler_end: function(text) {
        console.log(stdlib.strings[text - 1] + ': ' + Math.round(now() - time) + 'ms');
      },

      String_new: function(ptr) {
        stdlib.strings.push(extractLengthPrefixedString(stdlib.ints, stdlib.bytes, ptr));
        return stdlib.strings.length;
      },

      String_length: function(self) {
        return stdlib.strings[self - 1].length;
      },

      String_get: function(self, index) {
        return stdlib.strings[self - 1].charCodeAt(index);
      },

      String_append: function(self, other) {
        stdlib.strings.push(stdlib.strings[self - 1] + stdlib.strings[other - 1]);
        return stdlib.strings.length;
      },

      String_appendNew: function(self, other) {
        stdlib.strings.push(stdlib.strings[self - 1] + extractLengthPrefixedString(stdlib.ints, stdlib.bytes, other));
        return stdlib.strings.length;
      },

      String_slice: function(self, start, end) {
        stdlib.strings.push(stdlib.strings[self - 1].slice(start, end));
        return stdlib.strings.length;
      },

      String_equal: function(self, other) {
        return stdlib.strings[self - 1] === stdlib.strings[other - 1];
      },

      String_equalNew: function(self, other) {
        return stdlib.strings[self - 1] === extractLengthPrefixedString(stdlib.ints, stdlib.bytes, other);
      },

      String_toStringSigned: function(value) {
        stdlib.strings.push((value | 0).toString());
        return stdlib.strings.length;
      },

      String_toStringUnsigned: function(value) {
        stdlib.strings.push((value >>> 0).toString());
        return stdlib.strings.length;
      },

      String_quote: function(self) {
        stdlib.strings.push(JSON.stringify(stdlib.strings[self - 1]));
        return stdlib.strings.length;
      },
    };
    return stdlib;
  }

  function loadStdlibForJavaScript() {
    var time = 0;

    return {
      assert: function(truth) {
        if (!truth) {
          throw new Error('Assertion failed');
        }
      },

      Profiler_begin: function() {
        time = now();
      },

      Profiler_end: function(text) {
        console.log(text + ': ' + Math.round(now() - time) + 'ms');
      },

      String_new: function(value) {
        return value;
      },

      String_length: function(self) {
        return self.length;
      },

      String_get: function(self, index) {
        return self.charCodeAt(index);
      },

      String_append: function(self, other) {
        return self + other;
      },

      String_appendNew: function(self, other) {
        return self + other;
      },

      String_slice: function(self, start, end) {
        return self.slice(start, end);
      },

      String_equal: function(self, other) {
        return self === other;
      },

      String_equalNew: function(self, other) {
        return self === other;
      },

      String_toStringSigned: function(value) {
        return (value | 0).toString();
      },

      String_toStringUnsigned: function(value) {
        return (value >>> 0).toString();
      },

      String_quote: function(self) {
        return JSON.stringify(self);
      },

      Uint8Array_new: function(length) {
        return new Uint8Array(length);
      },
    };
  }

  var CompileTarget = {
    JAVASCRIPT: 1,
    WEBASSEMBLY: 2,
  };

  function compileWebAssembly(code) {
    var stdlib = loadStdlibForWebAssembly();
    var module = Wasm.instantiateModule(code, {globals: stdlib});
    var exports = module.exports;
    var memory = exports.memory;
    stdlib.bytes = new Uint8Array(memory);
    stdlib.ints = new Int32Array(memory);

    return function(input, target) {
      stdlib.strings = [];

      stdlib.strings.push('<stdin>');
      var nameString = stdlib.strings.length;

      stdlib.strings.push(input);
      var contentsString = stdlib.strings.length;

      exports.Compiler_resetHeapPointer();
      var compiler = exports.Compiler_new(target);
      exports.Compiler_addInput(compiler, nameString, contentsString);
      exports.Compiler_finish(compiler);

      var wasm = exports.Compiler_wasm(compiler);
      var wasmData = wasm && stdlib.ints[wasm >> 2];
      var wasmLength = wasm && stdlib.ints[(wasm + 4) >> 2];

      return {
        wasm: wasm ? stdlib.bytes.subarray(wasmData, wasmData + wasmLength) : null,
        log: stdlib.strings[exports.Compiler_log(compiler) - 1] || '',
        js: stdlib.strings[exports.Compiler_js(compiler) - 1] || '',
      };
    };
  }

  function compileJavaScript(code) {
    var stdlib = loadStdlibForJavaScript();
    var exports = {};
    new Function('globals', 'exports', code)(stdlib, exports);

    return function(input, target) {
      var compiler = exports.Compiler_new(target);
      exports.Compiler_addInput(compiler, '<stdin>', input);
      exports.Compiler_finish(compiler);

      var wasm = exports.Compiler_wasm(compiler);

      return {
        wasm: wasm ? wasm._data.subarray(0, wasm._length) : null,
        log: exports.Compiler_log(compiler),
        js: exports.Compiler_js(compiler),
      };
    };
  }

  function hexdump(bytes) {
    var text = '';
    var rows = bytes.length + 15 >>> 4;

    for (var i = 0; i < rows; i++) {
      if (i > 0) {
        text += '\n';
      }

      var columns = Math.min(16, bytes.length - i * 16);

      for (var j = 0; j < columns; j++) {
        text += (0x100 | bytes[i * 16 + j]).toString(16).slice(-2) + ' ';
      }

      for (var j = columns; j < 16; j++) {
        text += '   ';
      }

      text += '| ';

      for (var j = 0; j < columns; j++) {
        var c = bytes[i * 16 + j];
        text += c >= 0x20 && c <= 0x7E ? String.fromCharCode(c) : '\xB7';
      }
    }

    return text;
  }

  function now() {
    return window.performance && performance.now ? performance.now() : +new Date;
  }

  function compile() {
    var target = targetJavaScript.checked ? CompileTarget.JAVASCRIPT : CompileTarget.WEBASSEMBLY;

    try {
      // Compile to JS
      var before = now();
      if (backendWebAssembly.checked) {
        console.log('compiling to JavaScript using WebAssembly');
        var compilerJS = compiledWebAssembly(input.value, CompileTarget.JAVASCRIPT);
      } else {
        console.log('compiling to JavaScript using JavaScript');
        var compilerJS = compiledJavaScript(input.value, CompileTarget.JAVASCRIPT);
      }
      var after = now();
      var jsTime = Math.round(after - before);
      console.log('total time: ' + jsTime + 'ms');

      // Compile to WASM
      var before = now();
      if (backendWebAssembly.checked) {
        console.log('compiling to WebAssembly using WebAssembly');
        var compilerWASM = compiledWebAssembly(input.value, CompileTarget.WEBASSEMBLY);
      } else {
        console.log('compiling to WebAssembly using JavaScript');
        var compilerWASM = compiledJavaScript(input.value, CompileTarget.WEBASSEMBLY);
      }
      var after = now();
      var wasmTime = Math.round(after - before);
      console.log('total time: ' + wasmTime + 'ms');
    }

    catch (e) {
      var message = e + '';
      if (e.stack) {
        message = e.stack.indexOf(message) !== -1 ? e.stack : message + '\n' + e.stack;
      }
      output.value = message;
      downloadName = 'error.txt';
      blobToDownload = new Blob([message], {type: 'text/plain'});
      return;
    }

    var log = (targetJavaScript.checked ? compilerJS : compilerWASM).log;

    if (log) {
      output.value = log;
      downloadName = 'log.txt';
      blobToDownload = new Blob([log], {type: 'text/plain'});
    }

    else if (targetJavaScript.checked) {
      output.value = compilerJS.js;
      downloadName = 'compiled.js';
      blobToDownload = new Blob([compilerJS.js], {type: 'text/plain'});
    }

    else {
      output.value = compilerWASM.wasm && hexdump(compilerWASM.wasm);
      downloadName = 'compiled.wasm';
      blobToDownload = new Blob([compilerWASM.wasm], {type: 'application/octet-stream'});
    }

    javaScriptToRun = joinLines([
      'function compileAndRunJavaScript(compiled) {',
      '  var globals = {',
      '    print: function(text) {',
      '      console.log(text);',
      '    },',
      '  };',
      '  var exports = {};',
      '  var code = new Function("globals", "exports", compiled)',
      '  code(globals, exports);',
      '  var result = exports.main();',
      '  console.log("result:", result);',
      '}',
      '',
      'compileAndRunJavaScript(' + JSON.stringify(compilerJS.js || compilerJS.log) + ');',
    ]);

    webAssemblyToRun = joinLines([
      'function compileAndRunWebAssembly(compiled) {',
      '  var extractLengthPrefixedString = function(ptr) {',
      '    var text = "", length = ints[ptr >> 2], i = ptr + 4;',
      '    while (length-- > 0) text += String.fromCharCode(bytes[i++]);',
      '    return text;',
      '  };',
      '  var globals = {',
      '    print: function(ptr) {',
      '      console.log(extractLengthPrefixedString(ptr));',
      '    },',
      '  };',
      '  var exports = Wasm.instantiateModule(compiled, {globals: globals}).exports;',
      '  var bytes = new Uint8Array(exports.memory);',
      '  var ints = new Int32Array(exports.memory);',
      '  var result = exports.main();',
      '  console.log("result:", result);',
      '}',
      '',
      'compileAndRunWebAssembly(new Uint8Array([' + (compilerWASM.wasm ? Array.prototype.slice.call(compilerWASM.wasm).join(', ') : '') + ']));',
    ]);

    usage.textContent = targetWebAssembly.checked ? webAssemblyToRun : javaScriptToRun;
    compileTime.textContent = (targetWebAssembly.checked ? wasmTime : jsTime) + 'ms';
  }

  function downloadCompiledResult() {
    var link = document.createElement('a');
    link.href = URL.createObjectURL(blobToDownload);
    link.download = downloadName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function logAppend() {
    log.value += (log.value !== '' ? '\n' : '') + '> ' + Array.prototype.map.call(arguments, function(item) {
      var text = item + '';
      return text === '' || text.indexOf('\n') !== -1 ? JSON.stringify(text) : text;
    }).join(' ');
    log.scrollTop = log.scrollHeight;
  }

  function runCompiledResult() {
    var code = new Function('console', targetWebAssembly.checked && supportsWebAssembly() ? webAssemblyToRun : javaScriptToRun);
    var target =
      targetJavaScript.checked ? 'JavaScript' :
      supportsWebAssembly() ? 'WebAssembly' :
      'JavaScript (WebAssembly is not supported by your browser)';
    clear.disabled = false;
    log.value += (log.value !== '' ? '\n\n' : '') + 'Running using ' + target + ':';

    try {
      code({ log: logAppend });
    } catch (e) {
      logAppend(e + '');
    }
  }

  function clearLog() {
    log.value = '';
    clear.disabled = true;
  }

  function supportsWebAssembly() {
    return typeof Wasm !== 'undefined';
  }

  function main() {
    loadWebAssembly(function(wasm) {
      loadedWebAssembly = wasm;

      loadJavaScript(function(js) {
        loadedJavaScript = js;

        backendWebAssembly.onchange = compile;
        backendJavaScript.onchange = compile;
        targetWebAssembly.onchange = compile;
        targetJavaScript.onchange = compile;
        input.oninput = compile;
        download.onclick = downloadCompiledResult;
        run.onclick = runCompiledResult;
        clear.onclick = clearLog;

        compiledJavaScript = compileJavaScript(loadedJavaScript);

        if (supportsWebAssembly()) {
          compiledWebAssembly = compileWebAssembly(loadedWebAssembly);
          backendWebAssembly.checked = true;
        }

        else {
          backendJavaScript.checked = true;
          backendWebAssembly.disabled = true;
          document.body.className = 'wasm-unavailable';
        }

        input.value = example;
        input.selectionStart = 0;
        input.selectionEnd = 0;
        compile();
      });
    });
  }

  main();
})();

</script>
