<meta charset="utf8">
<title>ThinScript Compiler Demo</title>
<style>
  body {
    font: 14px/150% sans-serif;
    margin: 50px 0 50px 50px;
  }

  h1, p {
    padding-right: 50px;
    clear: both;
  }

  h1 {
    margin-bottom: 50px;
  }

  p {
    max-width: 800px;
    margin: 0 0 30px 0;
  }

  h2 {
    clear: both;
    margin: 0;
    height: 50px;
    line-height: 30px;
  }

  a {
    color: inherit;
  }

  .not-supported-warning-text {
    display: none;
  }

  .wasm-unavailable .wasm-backend-text {
    color: #BBB;
  }

  .wasm-unavailable .not-supported-warning-text {
    display: inline;
  }

  button {
    position: absolute;
    width: 100px;
    height: 30px;
    top: 50px;
    right: 50px;
    background: white;
    border: 1px solid #BBB;
    border-top-right-radius: 5px;
    border-bottom-left-radius: 5px;
    font: inherit;
    line-height: 20px;
    padding: 1px 0;
    background: linear-gradient(white, #F7F7F7);
    cursor: pointer;
    color: black;
  }

  textarea {
    width: 100%;
    height: 400px;
    resize: vertical;
  }

  button:active:not(:disabled) {
    background: linear-gradient(#EEE, #F7F7F7);
    box-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
    padding: 2px 0 0 0;
  }

  button:focus, textarea:focus {
    outline: none;
    border-color: #777;
    box-shadow: 0 0 4px rgba(0, 0, 0, 0.5);
  }

  textarea:focus + button {
    border-color: #777;
  }

  button:disabled {
    color: black;
    opacity: 0.5;
    cursor: default;
  }

  textarea, code {
    font: 12px/130% Consolas, monospace;
  }

  textarea {
    border: 1px solid #CCC;
    border-radius: 5px;
    padding: 5px;
  }

  section {
    position: relative;
    width: 50%;
    float: left;
    padding: 0 50px 50px 0;
    box-sizing: border-box;
  }

  .spacer {
    height: 50px;
  }
</style>
<body>
  <h1>ThinScript Compiler Demo</h1>

  <p>
    ThinScript is an experimental programming language that compiles to both WebAssembly and JavaScript.
    It's meant to be a thin layer on top of WebAssembly that makes it easier to work with: no dependencies and fast compile times.
    The syntax is inspired by TypeScript and the compiler is <a href="https://github.com/evanw/thinscript">open source</a> and bootstrapped (it can compile itself).
  </p>

  <p>
    This is still an experiment and isn't intended for real use yet.
    The generated code currently doesn't delete anything.
    WebAssembly is a volatile work-in-progress and the binary format will be changed before the final release.
    Debugging support for WebAssembly is non-existent in current implementations.
    You get the idea.
  </p>

  <div class="spacer"></div>

  <section>
    <h2>Input</h2>
    <textarea id="input" autofocus></textarea>
  </section>

  <section>
    <h2>Output</h2>
    <textarea id="output" readonly></textarea>
    <button id="download">Download</button>
  </section>

  <p>
    <b>Compile using:</b>
    <label><input type="radio" name="backend" id="backend-js"> JavaScript</label>
    <label><input type="radio" name="backend" id="backend-wasm"> <span class="wasm-backend-text">WebAssembly<span class="not-supported-warning-text"> (not supported by your browser)</span></span></label>
    <br>
    <b>Compile to:</b>
    <label><input type="radio" name="target" id="target-js"> JavaScript</label>
    <label><input type="radio" name="target" id="target-wasm" checked> WebAssembly<span class="not-supported-warning-text"> (not supported by your browser)</span></label>
  </p>

  <div class="spacer"></div>

  <section>
    <h2>Usage</h2>
    <textarea id="usage" readonly></textarea>
    <button id="run">Run</button>
  </section>

  <section>
    <h2>Log</h2>
    <textarea id="log" readonly></textarea>
    <button id="clear" disabled>Clear</button>
  </section>
</body>
<script>

(function() {
  var run = document.getElementById('run');
  var clear = document.getElementById('clear');
  var input = document.getElementById('input');
  var output = document.getElementById('output');
  var usage = document.getElementById('usage');
  var log = document.getElementById('log');
  var download = document.getElementById('download');

  var backendWebAssembly = document.getElementById('backend-wasm');
  var backendJavaScript = document.getElementById('backend-js');

  var targetWebAssembly = document.getElementById('target-wasm');
  var targetJavaScript = document.getElementById('target-js');

  var loadedWebAssembly = null;
  var loadedJavaScript = null;

  var downloadName = null;
  var javaScriptToRun = null;
  var webAssemblyToRun = null;
  var blobToDownload = null;

  function joinLines(lines) {
    return lines.join('\n');
  }

  var example = joinLines([
    'declare function print(text: string): void;',
    '',
    'class Link {',
    '  value: int;',
    '  next: Link;',
    '}',
    '',
    'class List {',
    '  first: Link;',
    '  last: Link;',
    '',
    '  append(value: int): void {',
    '    var link = new Link();',
    '    link.value = value;',
    '',
    '    // Append the new link to the end of the chain',
    '    if (this.first == null) this.first = link;',
    '    else this.last.next = link;',
    '    this.last = link;',
    '  }',
    '}',
    '',
    'extern function main(): int {',
    '  var list = new List();',
    '  list.append(1);',
    '  list.append(2);',
    '  list.append(3);',
    '',
    '  var total = 0;',
    '  var link = list.first;',
    '  while (link != null) {',
    '    total = total + link.value;',
    '    link = link.next;',
    '  }',
    '',
    '  print("hello, world");',
    '  return total;',
    '}',
  ]) + '\n';

  function fetch(url, responseType, callback) {
    var xhr = new XMLHttpRequest;
    xhr.open('GET', url);
    xhr.onload = function() {
      callback(xhr.response);
    };
    xhr.responseType = responseType;
    xhr.send(null);
  }

  function loadJavaScript(callback) {
    fetch('compiled.js', 'text', callback);
  }

  function loadWebAssembly(callback) {
    fetch('compiled.wasm', 'arraybuffer', function(buffer) {
      callback(new Uint8Array(buffer));
    });
  }

  function parseString(bytes, index, length) {
    var hasLength = length > 0;
    var text = '';

    while (hasLength ? length > 0 : bytes[index] !== 0) {
      text += String.fromCharCode(bytes[index]);
      index++;
      length--;
    }

    return text;
  }

  function loadStdlibForWebAssembly() {
    var strings = [];
    var stdlib = {
      strings: strings,
      bytes: null,

      assert: function(truth) {
        if (!truth) {
          throw new Error('Assertion failed');
        }
      },

      String_new: function(ptr) {
        strings.push(parseString(stdlib.bytes, ptr, 0));
        return strings.length;
      },

      String_newLength: function(ptr, length) {
        strings.push(parseString(stdlib.bytes, ptr, length));
        return strings.length;
      },

      String_length: function(self) {
        return strings[self - 1].length;
      },

      String_get: function(self, index) {
        return strings[self - 1].charCodeAt(index);
      },

      String_append: function(self, other) {
        strings.push(strings[self - 1] + strings[other - 1]);
        return strings.length;
      },

      String_appendNew: function(self, other) {
        strings.push(strings[self - 1] + parseString(stdlib.bytes, other));
        return strings.length;
      },

      String_slice: function(self, start, end) {
        strings.push(strings[self - 1].slice(start, end));
        return strings.length;
      },

      String_equal: function(self, other) {
        return strings[self - 1] === strings[other - 1];
      },

      String_equalNew: function(self, other) {
        return strings[self - 1] === parseString(stdlib.bytes, other);
      },

      String_toStringSigned: function(value) {
        strings.push((value | 0).toString());
        return strings.length;
      },

      String_toStringUnsigned: function(value) {
        strings.push((value >>> 0).toString());
        return strings.length;
      },

      String_quote: function(self) {
        strings.push(JSON.stringify(strings[self - 1]));
        return strings.length;
      },
    };
    return stdlib;
  }

  function loadStdlibForJavaScript() {
    return {
      assert: function(truth) {
        if (!truth) {
          throw new Error('Assertion failed');
        }
      },

      String_new: function(value) {
        return value;
      },

      String_newLength: function(value, length) {
        return value;
      },

      String_length: function(self) {
        return self.length;
      },

      String_get: function(self, index) {
        return self.charCodeAt(index);
      },

      String_append: function(self, other) {
        return self + other;
      },

      String_appendNew: function(self, other) {
        return self + other;
      },

      String_slice: function(self, start, end) {
        return self.slice(start, end);
      },

      String_equal: function(self, other) {
        return self === other;
      },

      String_equalNew: function(self, other) {
        return self === other;
      },

      String_toStringSigned: function(value) {
        return (value | 0).toString();
      },

      String_toStringUnsigned: function(value) {
        return (value >>> 0).toString();
      },

      String_quote: function(self) {
        return JSON.stringify(self);
      },

      ByteArray_new: function() {
        return [];
      },

      ByteArray_length: function(self) {
        return self.length;
      },

      ByteArray_getByte: function(self, index) {
        return self[index];
      },

      ByteArray_setByte: function(self, index, byte) {
        self[index] = byte & 255;
      },

      ByteArray_appendByte: function(self, byte) {
        self.push(byte & 255);
      },
    };
  }

  var CompileTarget = {
    JAVASCRIPT: 1,
    WEBASSEMBLY: 2,
  };

  function compileAndRunWebAssembly(code, input, target) {
    var stdlib = loadStdlibForWebAssembly();
    var module = Wasm.instantiateModule(code, {globals: stdlib});
    var exports = module.exports;
    var memory = exports.memory;

    stdlib.bytes = new Uint8Array(memory);

    stdlib.strings.push('<stdin>');
    var nameString = stdlib.strings.length;

    stdlib.strings.push(input);
    var contentsString = stdlib.strings.length;

    var compiler = exports.Compiler_new(target);
    exports.Compiler_addInput(compiler, nameString, contentsString);
    exports.Compiler_finish(compiler);

    var wasm = exports.Compiler_wasm(compiler);
    var ints = new Int32Array(memory);
    var wasmData = wasm && ints[wasm >> 2];
    var wasmLength = wasm && ints[(wasm + 4) >> 2];
    return {
      wasm: wasm ? stdlib.bytes.subarray(wasmData, wasmData + wasmLength) : null,
      log: stdlib.strings[exports.Compiler_log(compiler) - 1] || '',
      js: stdlib.strings[exports.Compiler_js(compiler) - 1] || '',
    };
  }

  function compileAndRunJavaScript(code, input, target) {
    var stdlib = loadStdlibForJavaScript();
    var exports = {};
    new Function('globals', 'exports', code)(stdlib, exports);

    var compiler = exports.Compiler_new(target);
    exports.Compiler_addInput(compiler, '<stdin>', input);
    exports.Compiler_finish(compiler);

    var wasm = exports.Compiler_wasm(compiler);
    return {
      wasm: wasm ? new Uint8Array(wasm) : null,
      log: exports.Compiler_log(compiler),
      js: exports.Compiler_js(compiler),
    };
  }

  function hexdump(bytes) {
    var text = '';
    var rows = bytes.length + 15 >>> 4;

    for (var i = 0; i < rows; i++) {
      if (i > 0) {
        text += '\n';
      }

      var columns = Math.min(16, bytes.length - i * 16);

      for (var j = 0; j < columns; j++) {
        text += (0x100 | bytes[i * 16 + j]).toString(16).slice(-2) + ' ';
      }

      for (var j = columns; j < 16; j++) {
        text += '   ';
      }

      text += '| ';

      for (var j = 0; j < columns; j++) {
        var c = bytes[i * 16 + j];
        text += c >= 0x20 && c <= 0x7E ? String.fromCharCode(c) : '\xB7';
      }
    }

    return text;
  }

  function compile() {
    var target = targetJavaScript.checked ? CompileTarget.JAVASCRIPT : CompileTarget.WEBASSEMBLY;

    try {
      if (backendWebAssembly.checked) {
        var compilerJS = compileAndRunWebAssembly(loadedWebAssembly, input.value, CompileTarget.JAVASCRIPT);
        var compilerWASM = compileAndRunWebAssembly(loadedWebAssembly, input.value, CompileTarget.WEBASSEMBLY);
      } else {
        var compilerJS = compileAndRunJavaScript(loadedJavaScript, input.value, CompileTarget.JAVASCRIPT);
        var compilerWASM = compileAndRunJavaScript(loadedJavaScript, input.value, CompileTarget.WEBASSEMBLY);
      }
    } catch (e) {
      var message = e + '';
      if (e.stack) {
        message = e.stack.indexOf(message) !== -1 ? e.stack : message + '\n' + e.stack;
      }
      output.value = message;
      downloadName = 'error.txt';
      blobToDownload = new Blob([message], {type: 'text/plain'});
      return;
    }

    var log = compilerJS.log || compilerWASM.log;

    if (log) {
      output.value = log;
      downloadName = 'log.txt';
      blobToDownload = new Blob([log], {type: 'text/plain'});
    }

    else if (targetJavaScript.checked) {
      output.value = compilerJS.js;
      downloadName = 'compiled.js';
      blobToDownload = new Blob([compilerJS.js], {type: 'text/plain'});
    }

    else {
      output.value = compilerWASM.wasm && hexdump(compilerWASM.wasm);
      downloadName = 'compiled.wasm';
      blobToDownload = new Blob([compilerWASM.wasm], {type: 'application/octet-stream'});
    }

    javaScriptToRun = joinLines([
      'function compileAndRunJavaScript(compiled) {',
      '  var globals = {',
      '    print: function(text) {',
      '      console.log(text);',
      '    },',
      '  };',
      '  var exports = {};',
      '  var code = new Function("globals", "exports", compiled)',
      '  code(globals, exports);',
      '  var result = exports.main();',
      '  console.log("result:", result);',
      '}',
      '',
      'compileAndRunJavaScript(' + JSON.stringify(compilerJS.js || '') + ');',
    ]);

    webAssemblyToRun = joinLines([
      'function compileAndRunWebAssembly(compiled) {',
      '  var extractString = function(ptr) {',
      '    var text = "";',
      '    while (ptr && bytes[ptr]) {',
      '      text += String.fromCharCode(bytes[ptr++]);',
      '    }',
      '    return text;',
      '  };',
      '  var globals = {',
      '    print: function(ptr) {',
      '      console.log(extractString(ptr));',
      '    },',
      '  };',
      '  var exports = Wasm.instantiateModule(compiled, {globals: globals}).exports;',
      '  var bytes = new Uint8Array(exports.memory);',
      '  var result = exports.main();',
      '  console.log("result:", result);',
      '}',
      '',
      'compileAndRunWebAssembly(new Uint8Array([' + (compilerWASM.wasm ? Array.prototype.slice.call(compilerWASM.wasm).join(', ') : '') + ']));',
    ]);

    usage.textContent = targetWebAssembly.checked ? webAssemblyToRun : javaScriptToRun;
  }

  function downloadCompiledResult() {
    var link = document.createElement('a');
    link.href = URL.createObjectURL(blobToDownload);
    link.download = downloadName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function runCompiledResult() {
    var code = new Function('console', targetWebAssembly.checked && supportsWebAssembly() ? webAssemblyToRun : javaScriptToRun);
    var target =
      targetJavaScript.checked ? 'JavaScript' :
      supportsWebAssembly() ? 'WebAssembly' :
      'JavaScript (WebAssembly is not supported by your browser)';
    clear.disabled = false;
    log.value += (log.value !== '' ? '\n\n' : '') + 'Running using ' + target + ':';
    code({
      log: function() {
        log.value += (log.value !== '' ? '\n' : '') + '> ' + Array.prototype.map.call(arguments, function(item) {
          var text = item + '';
          return text === '' || text.indexOf('\n') !== -1 ? JSON.stringify(text) : text;
        }).join(' ');
        log.scrollTop = log.scrollHeight;
      },
    });
  }

  function clearLog() {
    log.value = '';
    clear.disabled = true;
  }

  function supportsWebAssembly() {
    return typeof Wasm !== 'undefined';
  }

  function main() {
    loadWebAssembly(function(wasm) {
      loadedWebAssembly = wasm;

      loadJavaScript(function(js) {
        loadedJavaScript = js;

        backendWebAssembly.onchange = compile;
        backendJavaScript.onchange = compile;
        targetWebAssembly.onchange = compile;
        targetJavaScript.onchange = compile;
        input.oninput = compile;
        download.onclick = downloadCompiledResult;
        run.onclick = runCompiledResult;
        clear.onclick = clearLog;

        if (supportsWebAssembly()) {
          backendWebAssembly.checked = true;
        } else {
          backendJavaScript.checked = true;
          backendWebAssembly.disabled = true;
          document.body.className = 'wasm-unavailable';
        }

        input.value = example;
        compile();
      });
    });
  }

  main();
})();

</script>
